<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>GPS 測試</title>
    <script type="text/javascript">
        var dataPoints = [];
        var standardDeviation = 0;
        let MAX_DATA_POINTS = 10;
        var lastPixel = [];

        function addDataPoint(p) {
            if (dataPoints.length > MAX_DATA_POINTS) {
                dataPoints.shift() // Remove first (oldest) element
            }
            dataPoints.push(p); // Add new element

            var meanSqDistance = 0;
            var i;
            for (i = 0; i < dataPoints.length; ++i) {
                meanSqDistance += dataPoints[i][0]*dataPoints[i][0] + dataPoints[i][1]*dataPoints[i][1];
            }
            meanSqDistance /= dataPoints.length;

            var sdSq = 0;
            for (i = 0; i < dataPoints.length; ++i) {
                let inner = (dataPoints[i][0]*dataPoints[i][0] + dataPoints[i][1]*dataPoints[i][1]) - meanSqDistance;
                inner += inner*inner;
            }
            sdSq /= dataPoints.length;
            standardDeviation = Math.sqrt(sdSq);
        }

		var enableDrawing = false;
		var watchID;

		if (navigator.geolocation) {
			alert("GPS已被定位....千萬不可以動手!!!");
			// 支援GPS地理定位
			navigator.geolocation.getCurrentPosition(geoYes, geoNo, { enableHighAccuracy: true, timeout: 500000 });
		} else {
			alert("目前GPS無法定位....趕快補刀吧!!!");
		}

          function geoYes(evt) {
  			if (evt.coords === null) {
				str = "evt.coords不存在";
				document.getElementById("posStr").innerHTML = str;
				return
			}

			str = "緯度" + evt.coords.latitude;
			str += "<br />經度" + evt.coords.longitude;
			str += "<br />精確度" + evt.coords.accuracy;
			document.getElementById("posStr").innerHTML = str;

			//str = "http://maps.googleapis.com/maps/api/staticmap?zoom=15&size=300x300&sensor=false&center=" + evt.coords.latitude + "," + evt.coords.longitude;
			str = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBdXkqR9RYuoAUstYgivrJsMMdukIWcBNQ&callback=initMap"
			document.getElementById("map").src = str;

            let point = [evt.coords.latitude, evt.coords.longitude];
            let distanceSq = point[0]*point[0] + point[1]*point[1];

			if (dataPoints.length === 0) {
                let canvas = document.getElementById("myCanvas");
                lastPixel = [canvas.width/2, canvas.height/2];
                addDataPoint(point);
                firstPoint = true;
            } else if (dataPoints.length < MAX_DATA_POINTS || (distanceSq / standardDeviation) < 3) {
                addDataPoint(point);
            }

            if (dataPoints.length > 1 && enableDrawing) {
			    let lastDataPoint = dataPoints[dataPoints.length-2];
                var dLat = evt.coords.latitude - lastDataPoint[0];
                var dLong = evt.coords.longitude - lastDataPoint[1];

                //This will make (dLatScaled, dLongScaled) >= (1,1)
                let dLatAbs = Math.abs(dLat);
                let dLongAbs = Math.abs(dLong);
                var scalingFactor = 0;
                if (dLatAbs === 0 && dLongAbs === 0) {
                    return;
                } else if (dLatAbs === 0 && dLongAbs !== 0) {
                    scalingFactor = 1 / dLongAbs;
                } else if (dLatAbs !== 0 && dLongAbs === 0) {
                    scalingFactor = 1 / dLatAbs;
                } else {
                    scalingFactor = 1 / Math.min(dLatAbs, dLongAbs);
                }

                let dLatScaled = dLat * scalingFactor;
                let dLongScaled = dLong * scalingFactor;
                let newPixel = [lastPixel[0] + dLatScaled, lastPixel[1] + dLongScaled];

                //use dLat, dLong to draw line on map
                let canvas = document.getElementById("myCanvas");
                if (canvas.getContext) {
                    var context = canvas.getContext("2d");

                    context.beginPath();
                   // console.log("drawing from (" + pixelX + ", " + pixelY + ")...")
                    context.moveTo(lastPixel[0], lastPixel[1]);
                   // console.log("...to (" + pixelX + ", " + pixelY + ")")
                    context.lineTo(newPixel[0], newPixel[1]);
                    context.stroke()
                }

                lastPixel = newPixel;
            }
		}

		function geoNo(evt) {
			alert("GPS取得失敗");
		}

		function startGPS() {
			enableDrawing = true;

			watchID = navigator.geolocation.watchPosition(geoYes, geoNo);
			document.getElementById("watchStr").innerHTML = "GPS正在監控中...";

		}

		function stopGPS() {
			navigator.geolocation.clearWatch(watchID);
			document.getElementById("watchStr").innerHTML = "GPS停止監控中...";
		}
	</script>
    <style type="text/css">
      canvas { border: 1px solid black; }
    </style>
  </head>
  <body>
    <h1>定位資訊 </h1>
    <p id="posStr">111222</p>
    <p id="watchStr">監控狀態</p>
    <p>
      <input type="button" value="啟動GPS更新" onClick="startGPS();">
      <input type="button" value="停止GPS更新" onClick="stopGPS();">
    </p>
    <p>當啟動GPS更新,不用聯網也可持續更新!!!<br>
      只要網頁開著!
    </p>
    <hr>
    <p id = "posCoordinate">座標</p>
    <p><img id="map"/></p>
    <canvas id = "myCanvas" width="500" height="500"></canvas>
  </body>
</html>